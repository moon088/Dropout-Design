# 実験プログラムについて

目次

- [実験プログラムについて](#%e5%ae%9f%e9%a8%93%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%a0%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6)
  - [はじめに](#%e3%81%af%e3%81%98%e3%82%81%e3%81%ab)
  - [サポートする機能](#%e3%82%b5%e3%83%9d%e3%83%bc%e3%83%88%e3%81%99%e3%82%8b%e6%a9%9f%e8%83%bd)
  - [python 環境とライブラリ](#python-%e7%92%b0%e5%a2%83%e3%81%a8%e3%83%a9%e3%82%a4%e3%83%96%e3%83%a9%e3%83%aa)
  - [実行に必要な python ソースコード](#%e5%ae%9f%e8%a1%8c%e3%81%ab%e5%bf%85%e8%a6%81%e3%81%aa-python-%e3%82%bd%e3%83%bc%e3%82%b9%e3%82%b3%e3%83%bc%e3%83%89)
  - [プログラムの実行方法](#%e3%83%97%e3%83%ad%e3%82%b0%e3%83%a9%e3%83%a0%e3%81%ae%e5%ae%9f%e8%a1%8c%e6%96%b9%e6%b3%95)
  - [設定ファイル](#%e8%a8%ad%e5%ae%9a%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab)
  - [ログファイル](#%e3%83%ad%e3%82%b0%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab)
  - [出力結果のcsvへの保存](#%e5%87%ba%e5%8a%9b%e7%b5%90%e6%9e%9c%e3%81%aecsv%e3%81%b8%e3%81%ae%e4%bf%9d%e5%ad%98)
    - [テストデータに対するエポックごとのネットワークの出力値](#%e3%83%86%e3%82%b9%e3%83%88%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ab%e5%af%be%e3%81%99%e3%82%8b%e3%82%a8%e3%83%9d%e3%83%83%e3%82%af%e3%81%94%e3%81%a8%e3%81%ae%e3%83%8d%e3%83%83%e3%83%88%e3%83%af%e3%83%bc%e3%82%af%e3%81%ae%e5%87%ba%e5%8a%9b%e5%80%a4)
    - [テストデータに対するエポックごとの正解判定結果](#%e3%83%86%e3%82%b9%e3%83%88%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ab%e5%af%be%e3%81%99%e3%82%8b%e3%82%a8%e3%83%9d%e3%83%83%e3%82%af%e3%81%94%e3%81%a8%e3%81%ae%e6%ad%a3%e8%a7%a3%e5%88%a4%e5%ae%9a%e7%b5%90%e6%9e%9c)
    - [全実験結果の集計値](#%e5%85%a8%e5%ae%9f%e9%a8%93%e7%b5%90%e6%9e%9c%e3%81%ae%e9%9b%86%e8%a8%88%e5%80%a4)
  - [一時ファイル](#%e4%b8%80%e6%99%82%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab)
  - [改版履歴](#%e6%94%b9%e7%89%88%e5%b1%a5%e6%ad%b4)
  - [備考](#%e5%82%99%e8%80%83)

## はじめに

ドロップアウトデザイン実験用プログラムの説明です。
実験で使用するするファイルは *cifar10_nn.py* です(**名称は今後変更するかも**)。
ほぼ一から作っていますので、不具合があったらごめんなさい。

## サポートする機能

以下の機能をサポートしています。

- ドロップアウトデザインの生成
- 多層パーセプトロン、畳み込みニューラルネットワークでの実験
  - 実験回数の指定も可能（実験回数が大きい場合の動作確認は未実施）
  - デザインの使用有無、従来のドロップアウト法やドロップアウトなしの指定も可能
  - デザインを使用しない場合に、ハイパーパラメータの設定を自由にできる機能
- GridSearchCVを用いたグリッドサーチ
  - 現状は機能をOFFにしています。
- 予測結果出力機能
  - 実験繰り返し数、エポック数ごとに、下記の値をcsvに保存します。
    - テストデータに対する予測結果（確率値）
    - 正解値
    - 正解/不正解判定結果
    - 損失関数(分類の場合：カテゴリカルクロスエントロピーの値、回帰の場合：平均二乗誤差の値)
  - 全実験結果を集計し、エポックごとに下記の基本統計量をcsvに保存します。
    - 最大確率値の平均、分散、中央値
    - 正解の平均、分散、中央値
    - 損失関数の値の平均、分散、中央値

## python 環境とライブラリ

python 3.6.8 で動作を確認しています。
実行にはAnacondaを使用しています。
実行に際して、以下のライブラリをAnaconda環境にインストールしてください。

- Keras
- numpy
- scikit-learn
- sympy
- cloudpickle (Anacondaでは標準インストールされている模様)

## 実行に必要な python ソースコード

- FiniteField.py
  - 有限体の生成と、その上での各種演算を実行するためのライブラリです。cifar10_nn.pyと同じディレクトリにおいてください。
- PGDesign.py
  - FiniteField.pyを使用して、タイプ(1,2)かつ(2,1)-ドロップアウトデザインを生成します。cifar10_nn.pyと同じディレクトリにおいてください。
- cifar10_nn.py
  - 実験を行うには、このファイルを実行してください。
  - Kerasを使う実験プログラムは、すべてこのファイルに書かれています。
  - **名称は今後変更予定**

## プログラムの実行方法

コマンドライン引数でハイパーパラメータの値を設定するのをやめ、設定ファイルから読み込むようにしました。
設定ファイルのパスをコマンドライン引数の *-j* オプションで指定してください。

Anaconda jupyter notebookなら、下記のようになります。

```
!python cifar10_nn.py --json <設定ファイルのパス>
```

または

```
!python cifar10_nn.py -j <設定ファイルのパス>
```

例えば、

```
!python cifar10_nn.py -j "./hoge/poe.json"
```

とすると、cifar10_nn.py と同一ディレクトリにあるサブディレクトリ hoge に格納されている poe.json を読み込みます。
パスを二重引用符で囲うのを忘れないように。

下記のように -j オプションを省略した場合には、デフォルトとして cifar10_nn.py の親ディレクトリにあるconfディレクトリ下の example.json を読み込みます(パスは"../conf/example.json")。

```
!python cifar10_nn.py
```

## 設定ファイル

設定ファイルには、

- 使用するデザインの情報
- データセットの種類
- ネットワークの種類などのハイパーパラメータの値
- 実験の繰り返し数
- モデルを保存するパス

を記載します。

設定ファイルはjson形式で記載してください。

```json
{
    "network":"cnn",
    "dataset": "cifar10",
    "epochs":2,
    "experiments": 1,
    "shuffle": false,
    "design":
    {
        "design_csv": "dropoutdesign(5,3,3)v2.csv",
        "update_design_method": "rand_block",
        "repeat": 1,
        "degrees": 7,
        "prime_number": 2,
        "t_flats": 6,
        "dropout_mode": "non"
    },
    "manual":
    {
        "num_units": 64,
        "num_layers": 2,
        "num_batches": 32,
        "dropout_rate": 0.5
    },
    "data_augmentation": false,
    "optimizer":
     {
         "name": "SGD",
         "learning_rate": null,
         "decay": null
     },
    "checkpoint_path": "./model_checkpoint"
 }
```

現時点での各設定の詳細は下記の通りです。

- *network*
  - ニューラルネットのアーキテクチャの選択
    - "cnn" - 畳み込みニューラルネットワーク
    - "mlp" - 多層パーセプトロン
- *dataset*
  - 使用するデータセットで、null または下記設定値
    - null または "cifar10" - CIFAR-10
      - [CIFAR-10](https://www.cs.toronto.edu/~kriz/cifar.html)
    - "uniform" - 一様分布からサンプリングした10クラス分類用ランダムデータセット。*network* が "mlp" の場合のみ有効です("cnn" の場合の挙動は未確認)。
    - "uniform-regression" - 一様分布からサンプリングした回帰用ランダムデータセット。出力は1次元です。*network* が "mlp" の場合のみ有効です("cnn" の場合の挙動は未確認)。
- *epochs*
  - エポック数、1以上の整数値
- *experiments*
  - 実験数。同一のハイパーパラメータの設定値で実験を繰り返す回数。1以上の整数値。
- *shuffle*
  - 訓練データを各試行の前にシャッフルするかどうかを設定。
    - true: シャッフルする。
    - false: シャッフルしない。
- *design*
  - ドロップアウトデザインの設定で、null または下記の構造。
    - null - デザインを読み込まず、manualパラメータの設定値を使用する。
  - *design_csv*
    - デザインファイル(csv)のパス。nullまたは文字列。
      - null - デザインをファイルからではなくdegrees, prime_number, t_flatsパラメータ設定値を使用して、実行時に作成する。
      - 文字列 - デザインファイルを読み込んで使用する。
  - *update_design_method*
    - エポックごとのデザインの更新方法を指定する。
      - "shift_var" - デザインの要素に割り当てているユニットを1シフトさせる
      - "shift_block" - ブロックを1シフトさせる。
      - "rand_var" - デザインの要素に割り当てているユニットをランダムに置換する
      - "rand_block" - ブロックをランダムに並び替える
      - 上記以外の文字列またはnull : デザインの更新をせず、毎エポック同一の順序でブロックを使用する
  - *repeat*
    - 1エポックでのデザインの使用回数。1以上の整数値。
    - バッチサイズが使用回数に応じて変更される。
  - *degrees*
    - デザインを作成するためのパラメータその1。有限体の規約多項式の次数。2以上の整数値。
    - design_csvパラメータがnnullのときのみ有効。
  - *prime_number*
    - デザインを作成するためのパラメータその2。有限体を生成するための素数。素数以外はダメ。
    - design_csvパラメータがnullのときのみ有効。
  - *t_flats*
    - デザインを作成するためのパラメータその3。デザイン作成時に生成するt-flatの次数。1以上degrees未満の整数値。
    - design_csvパラメータがnullのときのみ有効。
  - *dropout_mode*
    - ドロップアウトの実行方法の指定。
      - "non" - ドロップアウトなし。
      - "random" - 従来のドロップアウト法。ドロップアウト率はデザインから決定する。
      - "design" - ドロップアウトデザインを使用したドロップアウト法。
- *manual*
  - デザインを使用せずに、ハイパーパラメータをマニュアル設定する。nullまたは下記の構造。
  - designパラメータがnullのときのみ有効。
  - *num_units* - 1層あたりのユニット数。1以上の整数値。
  - *num_layers* - 層の数。1以上の整数値。
  - *num_batches* - バッチ数。1以上の整数値。
    - バッチサイズは訓練データ数とバッチ数から算出する。
    - バッチサイズを指定できたほうが使いやすいと思うので、 *将来変更するかも* 。
  - *dropout_rate*
    - ドロップアウト率。0以上1未満の実数値。
    - 0の場合はドロップアウトなしになる。
- *data_augmentation*
  - データオーグメンテーションの有無。true(有り)またはfalse(無し)
- *optimizer*
  - 重み更新方法の設定。下記の構造で設定し、nullはダメ。
  - *name*
    - 重み更新法の名前を文字列で指定する。
    - https://keras.io/ja/optimizers/
      - "SGD" - 確率勾配降下法
      - "RMSProp" - RMSProp
      - "Adagrad" - Adagrad
      - "Adadelta" - Adadelta
      - "Adam" - Adam
      - "Adamax" - Adamax
      - Nadamには未対応。
    - *learning_rate*
      - 学習率。nullまたは0以上の実数が指定できるが、*nullが推奨*。
        - null - 各更新法のデフォルト値を使用する。
    - *decay*
      - 各更新での学習率の減衰量。nullまたは0以上の実数が指定できるが、*nullが推奨*
        - null - 各更新法のデフォルト値を使用する。
- *checkpoint_path*
  - エポックごとに保存するモデルのパス（拡張子はなし）を指定。nullまたは文字列。
    - null - モデルを保存しない。
  - 実際に保存する際には、checkpoint_pathパラメータの値に"_<実験の繰り返し数>"を付加したファイル名になる。

## ログファイル

以前から精度の値をログファイル(csv)に書き出していましたが、その機能を拡張し、ロスの値も出力するようにしました。

ログファイル名を以下のように変更しました。

```
log_<ネットワークアーキテクチャ>_<データセット名>_<層数>_<1層あたりのユニット数>_<1層の平均ドロップ数>.csv
```

例えば、畳み込みニューラルネットワークで9層、データセットにcifar10、1層あたり27ユニット、ドロップアウト率0.3の場合のログファイルは、

```
log_cnn_cifar10_9_27_9.csv
```

ログファイルの内容は以下の例の通り。

```csv
cifar10,non,1,1,2.302107362537384,2.301543768262863,0.11140000083766878,0.10690000072270632
cifar10,non,1,2,2.2997506555318834,2.297798608803749,0.1313400007712096,0.13500000089779496
cifar10,non,1,3,2.2949739982128143,2.291664707636833,0.14278000052556394,0.13800000019297004
cifar10,non,2,1,2.3021220300340652,2.3012242175102235,0.1186400007533282,0.14800000052973628
cifar10,non,2,2,2.3001053088521957,2.2985765372037887,0.14442000035077335,0.16969999927431345
cifar10,non,2,3,2.2960707598686216,2.2926915672779082,0.1720400000487268,0.1729000005915761
```

各列は左から、

- データセット名
  - cifar10 (CIFAR-10を使用した場合) 、 または、uniform (一様分布からサンプリングした10クラス分類用データを使用した場合)、uniform-regression (一様分布からサンプリングした回帰用データを使用した場合)
- ドロップアウト方式
  - non - ドロップアウトなし
  - random - 従来のドロップアウト
  - design - ドロップアウトデザインによるドロップアウト
- 実験の繰り返し数
- エポック数
- 訓練データに対する損失
- テスト(validation)データに対する損失
- 訓練精度
- テスト精度

上の例は、cifar10 データセットで、ドロップアウトなし、3エポックの実験を2回繰り返したもの。
1回目の実験でテスト精度が約14.3%、2回目の実験で約17.3%まで達している。

## 出力結果のcsvへの保存

訓練時のテストデータに対する予測結果や各集計値は、csvに保存されます。
現在のディレクトリの直下に下記のディレクトリを作成し、csvを保存します。
csvは上書きではなく、追記されます。

```
./models/
```

保存するcsvは3種類です。

- テストデータに対するエポックごとのネットワークの出力値
- テストデータに対するエポックごとの正解判定結果
- 全実験結果の集計値

### テストデータに対するエポックごとのネットワークの出力値

第一の *テストデータに対するエポックごとのネットワークの出力値* を保存するファイル名は次の通り。

```
pred_<ネットワーク構成>_<データセット名>_<層数>_<1層あたりのユニット数>_<1層あたりのドロップアウト数>_<実験回数>_<ドロップアウト方式>_<エポック数>_prediction_result.csv
```

- ネットワーク構成
  - mlp - 多層パーセプトロン
  - cnn - 畳み込みニューラルネットワーク
- データセット名
  - cifar10 - CIFAR10
  - uniform - 10クラス分類用データ。一様分布からのサンプリング
  - uniform-regression - 回帰用データ。一様分布からのサンプリング
- 実験回数 - 実験の繰り返し数（0スタート）
- ドロップアウト方式
  - non - ドロップアウトなし
  - random - 従来のドロップアウト
  - design - ドロップアウトデザインによるドロップアウト

出力例として、

```
pred_mlp_cifar10_2_64_32_0_non_001_prediction_result.csv
```

を下に掲載します。
「多層パーセプトロン、CIFAR-10、2層、1層あたり64ユニット、1層あたりのドロップアウト数32(これはデザインからの算出値)、繰り返し1回目、ドロップアウトなし、1エポック目」です。

```csv
0.06702706,0.05234814,0.12886235,0.12649204,0.14314967,0.1679052,0.14538473,0.10048622,0.042936526,0.025408054
0.054244976,0.24037963,0.02215534,0.011801105,0.008610627,0.010067256,0.00828801,0.029413033,0.2934982,0.32154185
0.14250553,0.17796548,0.024896834,0.015613058,0.015918879,0.02411746,0.008155033,0.05603164,0.39049903,0.14429708
0.21905555,0.09671268,0.093973815,0.048499934,0.0757142,0.061902393,0.022885725,0.10867952,0.21718566,0.055390537
```

出力は、CIFAR-10の各クラス(計10クラス)の分類確率です。
実際には、一番確率の高い分類が最終出力に選択されます。
各行はテストデータで、対応する各列がそのデータに対する分類確率です。
CIFAR-10はテストデータが10000件、クラス数が10なので、10000 x 10 の表が出力されるはずです。

なお、uniform-regressionのような回帰用データの場合は、ネットワークの出力値になります。

### テストデータに対するエポックごとの正解判定結果

第二の *テストデータに対するエポックごとの正解判定結果* は以下のファイル名で保存されます。

```
pred_<ネットワーク構成>_<データセット名>_<層数>_<1層あたりのユニット数>_<1層あたりのドロップアウト数>_<実験回数>_<ドロップアウト方式>_<エポック数>_evaluation_result.csv
```

上の構成例では、ファイル名は下記のようになります。

```
pred_mlp_cifar10_2_64_32_0_non_001_evaluation_result.csv
```

内容は以下の通り。

```csv
1,5,3,0.1679052,0.12649204,1.0,False,2.0675759105882796
2,9,8,0.32154185,0.2934982,1.0,False,1.2258838126215643
3,8,8,0.39049903,0.39049903,1.0,True,0.9403298050108427
4,0,0,0.21905555,0.21905555,1.0,True,1.5184299360757345
```

各列は左から、

- テストデータの添え字 [1-10000]
- ネットワークが分類したクラス
- 正解クラス
- 判定したクラスの分類確率（ネットワークの出力値）
- 正解クラスの分類確率（ネットワークの出力値）
- 正解クラスの正答率(常に1.0)
- 正解/不正解
  - False - 不正解
  - True - 正解
- 損失関数の値(カテゴリカルクロスエントロピー)

各行はテストデータに対する結果です。

uniform-regressionのような回帰用データの場合は、「ネットワークが分類したクラス」、「正解クラス」は出力されず、各列は以下のようになります。

- テストデータの添え字 [1-10000]
- ネットワークの出力値
- テストデータの正解値
- 正解/不正解
  - False - 不正解
  - True - 正解
- 損失関数の値(平均二乗誤差)


### 全実験結果の集計値

第三の *全実験結果の集計値* は下記の名前のcsvに保存されます。作成されるファイルは一つだけです。

```
pred_<ネットワーク構成>_<データセット名>_<層数>_<1層あたりのユニット数>_<1層あたりのドロップアウト数>_<ドロップアウト方式>_statistics_result.csv
```

上の構成例では、ファイル名は下記のようになります。

```
pred_mlp_cifar10_2_64_32_0_non_statistics_result.csv
```

内容は、エポックごとのテストデータを使った実験結果の集計データです。下が一例。

```csv
1,0.1613562,0.00952632,0.14074346,1.0,0.0,1.0,1.995220479330991,0.3718931610476402,1.9608163957523135
2,0.19123052,0.019756231,0.15350208,1.0,0.0,1.0,1.924222225126905,0.6239602347374411,1.8740412349339892
3,0.20438983,0.024399664,0.16205028,1.0,0.0,1.0,1.900313485888837,0.7484732877172324,1.8198486042927717
4,0.21618393,0.026993887,0.17138892,1.0,0.0,1.0,1.8554518701764322,0.7940337624766016,1.7638198536170138
```

各行はエポックごとの全実験の集計結果です。
集計には、実験の繰り返し回数xテストデータ数(10000件)の値を使っています。

各列は左から、

- エポック数
- 正解クラスに対するネットワークの出力値(分類確率)の平均値
- 正解クラスに対するネットワークの出力値(分類確率)の分散
- 正解クラスに対するネットワークの出力値(分類確率)の中央値
- 正解クラスに対する正答値の平均値 (テストデータの正解値で常に1)
- 正解クラスに対する正答値の分散(常に0)
- 正解クラスに対する正答値の中央値(常に1)
- 損失関数の値の平均値(損失関数は、分類データの場合はクロスエントロピー、回帰データの場合は平均二乗誤差)
- 損失関数の値の分散
- 損失関数の値の中央値

uniform-regressionのような回帰用データの場合は、各列は以下のようになります。

- エポック数
- ネットワークの出力値の平均値
- ネットワークの出力値の分散
- ネットワークの出力値の中央値
- 正答値の平均値
- 正答値の分散
- 正解クラスに対する正答値の中央値(常に1)
- 損失関数の値の平均値(損失関数は平均二乗誤差)
- 損失関数の値の分散
- 損失関数の値の中央値

## 一時ファイル

実行時間の高速化のために、実行中の途中経過を下記の一時ファイルに保存します。

- myprob_*.csv
- answer_*.csv
- loss_*.csv

これらのファイルを実験者が見る必要はありません。
これらのファイルの編集・削除、また、同じ名称のファイルの追加などの操作をしないようにしてください。

## 改版履歴

- 2019/12/6 README.md初版
- 2019/12/17 エポックごとに結果を出力する機能と、ネットワークの出力値と損失関数の値の要約統計量を出力する機能を追加
- 2019/12/25 デザインのブロックを固定にする機能を追加、デザインを使う場合に統計情報を計算できず例外が発生する問題を修正
- 2020/01/19 繰り返し訓練を実行すると、テスト時間が遅くなってくる現象を対策(動作は未確認)、example.jsonのパスを変更
- 2020/02/03 途中経過を一時ファイルに保存することで、繰り返し訓練を実行するとテスト時間が遅くなってくる現象をさらに対策しました
- 2020/02/21 データセットをcifar10またはuniformから選択できるようにしました
- 2020/02/24 データセットに回帰用データuniform-regressionを追加しました
- 2020/02/04 実行環境によって、on_epoch_endのログのキー acc, val_accがaccuracy, val_accuracyの場合があるので対応を追加
- 2021/04/01 訓練データをシャッフルするかどうかを設定するハイパーパラメータshuffleを追加しました。

## 備考

何かありましたらご連絡ねがいます。
